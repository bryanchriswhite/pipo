<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for server/js/managers/file.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../../prettify.css">
    <link rel="stylesheet" href="../../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header low">
    <h1>Code coverage report for <span class="entity">server/js/managers/file.js</span></h1>
    <h2>
        Statements: <span class="metric">15.63% <small>(10 / 64)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">0% <small>(0 / 14)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">12.5% <small>(1 / 8)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">15.63% <small>(10 / 64)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../index.html">All files</a> &#187; <a href="index.html">server/js/managers/</a> &#187; file.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143</td><td class="line-coverage"><span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var NotifyManager = require('./notify');
var EncryptionManager = require('./encryption');
var logger = require('../../../config/logger');
var PFile = require('../../models/pfile');
var ss = require('socket.io-stream');
&nbsp;
function FileManager() {
  this.notifyNewFile = <span class="fstat-no" title="function not covered" >function(data) {</span>
<span class="cstat-no" title="statement not covered" >    var socketServer = data.socketServer;</span>
<span class="cstat-no" title="statement not covered" >    var pfile = data.pfile;</span>
<span class="cstat-no" title="statement not covered" >    var signingKeyManager = data.signingKeyManager;</span>
<span class="cstat-no" title="statement not covered" >    var chatId;</span>
&nbsp;
    // Create the message to be displayed
<span class="cstat-no" title="statement not covered" >    var pfileMessage = "Hey, there is a file for you named '&lt;a id='" + pfile.id + "' class='pfile-link'&gt;" + pfile.name + "&lt;/a&gt;'";</span>
&nbsp;
    // Notify the users that this file was encrypted to that they have a file waiting
&nbsp;
    // - Should add a message to the appropriate chat with a clickable link
    //   - This link should open up a modal asking if the user wants to download encrypted or decrypt on reciept
&nbsp;
<span class="cstat-no" title="statement not covered" >    if ( !pfile.chatType ) {</span>
<span class="cstat-no" title="statement not covered" >      return logger.error("[FileManager.notifyNewFile] No chatType specified");</span>
    };
&nbsp;
    // These both get the chatId from teh same place. Need to merge chat and room and collapse this code.
<span class="cstat-no" title="statement not covered" >    if (pfile.chatType == 'room') {</span>
<span class="cstat-no" title="statement not covered" >      logger.debug("[FileManager.notifyNewFile] Type is room");</span>
<span class="cstat-no" title="statement not covered" >      chatId = pfile.toChatId;</span>
<span class="cstat-no" title="statement not covered" >      logger.debug("[FileManager.notifyNewFile] pfile.toRoom.id: " + pfile.toRoom.id);</span>
<span class="cstat-no" title="statement not covered" >      logger.debug("[FileManager.notifyNewFile] chatId: " + chatId);</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    if ( pfile.chatType == 'chat') {</span>
<span class="cstat-no" title="statement not covered" >      logger.debug("[FileManager.notifyNewFile] Type is chat");</span>
<span class="cstat-no" title="statement not covered" >      chatId = pfile.toChatId;</span>
<span class="cstat-no" title="statement not covered" >      logger.debug("[FileManager.notifyNewFile] pfile.toRoom.id: " + pfile.toRoom.id);</span>
<span class="cstat-no" title="statement not covered" >      logger.debug("[FileManager.notifyNewFile] chatId: " + chatId);</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    var messageData = {</span>
      chatType: pfile.chatType,
      pfileId: pfile.id,
      chatId: chatId,
      message: pfileMessage,
      socketServer: socketServer,
      signingKeyManager: signingKeyManager
    };
&nbsp;
<span class="cstat-no" title="statement not covered" >    logger.debug("[FileManager.notifyNewFile] Sending call to NotifyManager with chatId: ", chatId);</span>
&nbsp;
    // Server should let users of a chat know that a file has been uploaded (in case the user fails to notify after success upload)
<span class="cstat-no" title="statement not covered" >    NotifyManager.sendToChat(messageData);</span>
  }
&nbsp;
  this.handleChunk = <span class="fstat-no" title="function not covered" >function handleChunk(data) {</span>
<span class="cstat-no" title="statement not covered" >    var self = this;</span>
<span class="cstat-no" title="statement not covered" >    var socketServer = data.socketServer;</span>
<span class="cstat-no" title="statement not covered" >    var fileBuffer = data.buffer;</span>
<span class="cstat-no" title="statement not covered" >    var fileName = data.fileName;</span>
<span class="cstat-no" title="statement not covered" >    var systemUser = EncryptionManager.systemUser;</span>
<span class="cstat-no" title="statement not covered" >    var chatType = data.chatType;</span>
<span class="cstat-no" title="statement not covered" >    var chunkNumber = data.chunkNumber;</span>
<span class="cstat-no" title="statement not covered" >    var chunkCount = data.chunkCount;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    logger.debug("[file.handleChunk] Got onSendFile!");</span>
<span class="cstat-no" title="statement not covered" >    logger.debug("[file.handleChunk] chatType is: ", chatType, " file: " + fileName + " chunk " + chunkNumber + " out of " + chunkCount + " chunks.");</span>
&nbsp;
    // Add chunk to PFile (if it doesn't exist yet, add should create it (should confirm that it is the same user somehow)
&nbsp;
    // Create PFile object to keep track of the file
    // This way all members of that chat can list files that they have access to.
<span class="cstat-no" title="statement not covered" >    PFile.addChunk(data, <span class="fstat-no" title="function not covered" >function(err, pfile) {</span></span>
<span class="cstat-no" title="statement not covered" >      logger.debug("[file.handleChunk] Callback called in PFile.addChunk");</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >      if (err) {</span>
<span class="cstat-no" title="statement not covered" >        return logger.error("[file.handleChunk] Error saving file: " + err);</span>
        // Notify the client of an error here
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      if (!pfile) {</span>
<span class="cstat-no" title="statement not covered" >        return logger.warning("[file.handleChunk] No pfile returned... Something bad happened.");</span>
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      console.log("[file.handleChunk] About to try to send notification to clients...");</span>
&nbsp;
      // Should create some sort of timer to make sure all chunks get uploaded in a reasonable time and notify the user of fail if not
      // then remote the bad data
&nbsp;
<span class="cstat-no" title="statement not covered" >      if (pfile &amp;&amp; pfile.isComplete) {</span>
        // Get the pipo user (should move this to an init method in encryption manager and save it to state)
<span class="cstat-no" title="statement not covered" >        EncryptionManager.buildKeyManager(systemUser.publicKey.toString(), systemUser.privateKey.toString(), 'pipo', <span class="fstat-no" title="function not covered" >function(err, pipoKeyManager) {</span></span>
<span class="cstat-no" title="statement not covered" >          self.notifyNewFile({ signingKeyManager: pipoKeyManager, socketServer: socketServer, pfile: pfile });</span>
        });
      };
    });
  };
&nbsp;
  this.handleGetFile = <span class="fstat-no" title="function not covered" >function handleGetFile(data) {</span>
    // Get the user info from the socket
<span class="cstat-no" title="statement not covered" >    var pfileId = data.id;</span>
<span class="cstat-no" title="statement not covered" >    var socket = data.socket;</span>
<span class="cstat-no" title="statement not covered" >    var binSocket = data.binSocket;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    logger.debug("[socketServer.onGetFile] Getting pFile with ID: " + pfileId);</span>
&nbsp;
    // Get the pFile
<span class="cstat-no" title="statement not covered" >    PFile.get(pfileId, <span class="fstat-no" title="function not covered" >function(err, pfile) {</span></span>
<span class="cstat-no" title="statement not covered" >      var chunkCount = pfile.chunkCount;</span>
<span class="cstat-no" title="statement not covered" >      var currentChunk = 0;</span>
&nbsp;
      // Determine if the user actually has access to the requested file and that it exists
&nbsp;
      // Get the number of chunks and get the file buffer for each one sending it back to the client
<span class="cstat-no" title="statement not covered" >      while (currentChunk &lt; chunkCount) {</span>
        //var ssChunkStream = ss.createStream();
        //var ssChunkStream = ss.createBlobReadStream();
&nbsp;
<span class="cstat-no" title="statement not covered" >        pfile.getChunk(currentChunk, <span class="fstat-no" title="function not covered" >function(err, chunkStream) {</span></span>
<span class="cstat-no" title="statement not covered" >          currentChunk++;</span>
<span class="cstat-no" title="statement not covered" >          var fileData = {</span>
            id: pfile.id,
            fileName: pfile.name,
            chunkCount: pfile.chunkCount,
            chunkNumber: currentChunk
          }
&nbsp;
          // Send the file to the user with socket.emit
<span class="cstat-no" title="statement not covered" >          logger.debug("[socketServer.onGetFile] Sending file chunk with ID '" + pfile.id + "' to user '" + socket.user.username + "'");</span>
          //ss(socket).emit('file', ssChunkStream, fileData);
          //socket.emit('file', chunkStream, fileData);
<span class="cstat-no" title="statement not covered" >          binSocket.send(chunkStream, fileData);</span>
<span class="cstat-no" title="statement not covered" >          logger.debug("[socketServer.onGetFile] Sent emit, piping to stream");</span>
          //ssChunkStream.pipe(chunkStream);
          //logger.debug("[socketServer.onGetFile] Piped to client. Ending...");
        });
      };
    });
  };
};
&nbsp;
module.exports = new FileManager();
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue May 31 2016 08:15:47 GMT-0400 (EDT)</div>
</div>
<script src="../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../sorter.js"></script>
</body>
</html>
